
<!DOCTYPE = html>


<html style="margin-left:0px; margin-top:0px; padding:0px;">
<style>
	.pathogen-window {
		border: 0px solid #FF0000;
		background: #22222233;
	
		position: absolute;
		left: 0;
		top: 0;
	}
	.cell-controls {
		position: absolute;
		top: 200;
		border: 1px solid #222222;
		padding: 10px;
	}
	.cell-controls > label {
		display: block;
		margin: 20px;
	}
	.cell-controls > label > input {
		width: 30px;
		height: 30px;
	}
	#p1-controls {
		left:50;
	}
	#p2-controls {
		left: 1300;
	}
</style>
<head>
	<title>Pathogen</title>
</head>

<body>
	<canvas id="game-canvas" class="pathogen-window"></canvas>

	<div id="p1-controls" class="cell-controls">
		<label><input type="radio">A</label>
		<label><input type="radio">B</label>
		<label><input type="radio">C</label>
	</div>

	<div id="p2-controls" class="cell-controls">
		<label><input type="radio">A</label>
		<label><input type="radio">B</label>
		<label><input type="radio">C</label>
	</div>




<script src="scripts/pathogen.js"></script>
<script>

	level_input = document.getElementById("level");

	canvas = document.getElementById("game-canvas")
	canvas.width = document.body.clientWidth;
	canvas.height = document.body.clientHeight;

	game = new Pathogen(canvas);
	game.render();
	player = {auth_key: -1, id:-1, index:0};

	
	function packPostMsg(data){
		let post = {};
		post.method = "POST";
		post.headers = {"Content-Type" : "application/json"};
		post.body = JSON.stringify(data);
		return post;
	}// getPostData

	function update(){
		let tx = {auth_key: player.auth_key, turn_index: player.index};
		let data = packPostMsg(tx);

		fetch ("/update", data)
		.then ( function (response){
			return response.json();
		}).then ( function (body){
			let turns = body.turns;
			for (let i=0; i<turns.length; i++){
				console.log("Processing turn: "+turns[i]);
				game.click(turns[i].col, turns[i].row, turns[i].player, turns[i].type)
				player.index += 1;
				while (game.waves_c > 0);
			}
			setTimeout(update, 1000);
		});
	}// update

	function connect(){
		let data = packPostMsg({});
		fetch ("/new-user", data)
		.then( function (response){
			return response.json();
		})
		.then( function (body){
			player.auth_key = body.auth_key;
			player.id = body.player_id;
			console.log("Connected: "+player.id+":"+player.auth_key);
			setTimeout( update, 1000);
		});
	}// connect

	function sendClick(col, row, type){
		let click = {auth_key: player.auth_key, col: col, row: row, type: type};
		let data = packPostMsg(click);

		console.log("Sending Click: "+click);

		fetch ("/click", data)
		.then( function (response){
			let success = response.json().success;
		});
	}// sendClick


	canvas.addEventListener("click", function(event){
		let mx = event.pageX;
		let my = event.pageY;
		mx -= game.board.x;
		my -= game.board.y;
		mx = Math.floor(mx/game.board.unit);
		my = Math.floor(my/game.board.unit);

		//let level = parseInt(level_input.value);
		let level = 1;

		sendClick(mx, my, level);
	});

	connect();
</script>


</body>
</html>
